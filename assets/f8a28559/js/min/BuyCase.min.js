"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},BuyCase=function(e){function t(e){LandingCore.logError({urlToLog:o.urlToLog,transactionId:o.trid,categoryName:o.categoryName,error:e.stack})}var o=$.extend(!0,{emptyRetailModal:"",getCaseInfoUrl:"",buyCaseUrl:"",urlToLog:"",trid:"",categoryName:"",getUpsalesUrl:"",allowUpsales:!1,promoCodeCheckUrl:"",loggedIn:"",visitor:null,upsales:{},promocodeSettings:{promotionalCodeType:"",promotionalCodeSubType:"",promoCodeSubTypes:{}}},e),s={retailModal:".retail-modal",outerGameTabs:".outer-game-tabs",outerTabPane:".outer-tab-pane",fancyboxImage:".fancybox-image",gameBlockOuter:".game-block-outer",discountTooltip:".discount-tooltip",payModal:"#payModal",rulesModal:"#rules",payModalInitiator:'[data-toggle="pay-modal"]',payModalPromoInitiator:'[data-toggle="pay-modal-promo"]',promocodeHash:".promo-code-hash",promoboxCard:".promo-boxes--card",promoErrorMsg:".promo-error-msg"},a={checkPromocode:!1,buyAction:!1},r=$("body"),l="rules-on",i="percent",c="fix",n={initiated:!1,init:function(){this.initiated=!0,this.attachEvents()},show:function(){try{this.initiated||this.init(),$(s.retailModal).modal("show")}catch(e){throw t(e),e}},hide:function(){$(s.retailModal).modal("hide")},attachEvents:function(){try{r.on("shown.bs.modal",s.retailModal,function(){$(s.discountTooltip).tooltip()}).on("hidden.bs.modal",s.retailModal,function(){$(this).remove()})}catch(e){throw t(e),e}}},d={caseName:"",casePrice:"",caseId:"",promocode:"",xDrop:null,quantity:0,$modal:null,selectors:{title:"#payModal #paymodal-title",sum:"#payModal #payform-sum",quantity:"#payModal #payform-quantity",termsLink:"#payModal #payform-show-terms",caseId:"#payModal #payform-case-id",promocode:"#payModal #payform-promocode",emailInput:"#payModal #payform-email",submitBtn:"#payModal #payform-submit",paymodalForm:"#paymodal-form",errorMsg:"#payform-error-msg",rulesCheckbox:"#payModal #payform-rules",validateEmail:"#payModal #payform-validate-email",emailValidationCheck:"#payModal .email-validation-check",xDropBlock:"#x-drop-block",textXDrop:"#text-x-drop"},setXDropText:function(e){try{if(e===!1)return $(this.selectors.xDropBlock).css("display","none"),!1;if(null!=this.xDrop&&this.xDrop>1)$(this.selectors.xDropBlock).css("display","block"),$(this.selectors.textXDrop).html(LandingCore.t("Покупая данный кейс, вы получаете {game} и еще {drop} в подарок в своем личном кабинете пользователя.",{game:e+" "+LandingCore.plural(e,[LandingCore.t("игру"),LandingCore.t("игры"),LandingCore.t("игр")]),drop:this.xDrop*e-e}));else if(null==this.xDrop)throw new Error("xDrop is missing. CaseID = "+$(this.selectors.caseId).val())}catch(e){t(e)}},show:function(){try{this.$modal||(this.$modal=$(s.payModal),this.attachEvents(),this.initTouchSpin()),("undefined"!=typeof $.cookie(l)||o.loggedIn)&&($(this.selectors.rulesCheckbox).prop("checked",!0),$(this.selectors.rulesCheckbox).closest(".form-group").addClass("hidden")),this.fillData(),o.allowUpsales&&this.initUpsale(),this.$modal.modal("show")}catch(e){throw t(e),e}},hide:function(){try{this.$modal.modal("hide")}catch(e){throw t(e),e}},setParams:function(e){try{this.caseName=e.attr("data-item-title"),this.casePrice=parseFloat(e.attr("data-item-price")),this.caseId=e.attr("data-item-id"),this.promocode=e.attr("data-promocode")||"",this.xDrop=e.attr("data-item-x-drop")||null}catch(e){throw t(e),e}},fillData:function(){try{$(this.selectors.title).text(this.caseName),this.setSum(this.casePrice),$(this.selectors.quantity).val(1),$(this.selectors.caseId).val(this.caseId),$(this.selectors.promocode).val(this.promocode),this.setXDropText(1)}catch(e){throw t(e),e}},clearData:function(e){try{$(this.selectors.title).text(""),this.setSum(0),$(this.selectors.quantity).val(1),$(this.selectors.caseId).val(""),$(this.selectors.promocode).val(""),this.setXDropText(!1),p.upsaleHide(e)}catch(e){throw t(e),e}},initTouchSpin:function(){try{var e=$(this.selectors.quantity);e.TouchSpin({min:1,max:50,step:1}),e.on("change",$.proxy(function(e,t){var o=parseInt($(this.selectors.quantity).val());this.setXDropText(o),this.setSum(this.casePrice*o),p.calculateUpsalePrice()},this))}catch(e){throw t(e),e}},initUpsale:function(){try{var e={idCase:this.caseId};e._csrf=LandingCore.getCsrfToken(),$(p.selectors.upsaleBlock).show(),$.ajax({url:o.getUpsalesUrl,method:"POST",dataType:"json",data:e,success:function(e){return"error"===e.status?($(p.selectors.upsaleBlock).hide(),!1):void("ok"===e.status&&p.fillUpsale(e.percents,e.upsales,e.items,e.const))},error:function(e,t,o){}})}catch(e){throw t(e),e}},setSum:function(e){try{$(this.selectors.sum).text(e)}catch(e){throw t(e),e}},showError:function(e){try{$(this.selectors.errorMsg).removeClass("hidden").find(".alert").html(e)}catch(e){throw t(e),e}},hideError:function(){try{$(this.selectors.errorMsg).addClass("hidden").find(".alert").html("")}catch(e){throw t(e),e}},attachEvents:function(){try{$(this.selectors.termsLink).on("click",this.onShowTermsLink),this.$modal.on("hidden.bs.modal",$.proxy(this.onBsHidden,this)),$(this.selectors.submitBtn).on("click",$.proxy(this.onSubmit,this)),$(this.selectors.rulesCheckbox).on("click",$.proxy(this.onRulesChecked,this)),$("body").on("click",this.selectors.emailValidationCheck,$.proxy(this.onEmailValidationCheck,this))}catch(e){throw t(e),e}},onBsHidden:function(){try{this.clearData(!0),this.hideError(),a.buyAction=!1}catch(e){throw t(e),e}},onRulesChecked:function(){try{$(this.selectors.rulesCheckbox).prop("checked")&&$.cookie(l,1,{expires:365,path:"/"})}catch(e){throw t(e),e}},onEmailValidationCheck:function(e){try{e.preventDefault();var o=$(e.target),s=o.data("email"),a=o.data("validate-email");$(this.selectors.validateEmail).val(a),$(this.selectors.emailInput).val(s),$(this.selectors.submitBtn).click()}catch(e){throw t(e),e}},onSubmit:function(e){var r=this;try{var l=function(){if(e.preventDefault(),a.buyAction)return{v:!1};var t=$(e.target),l=t.closest("form"+r.selectors.paymodalForm),i=r;if(!$(l).get(0).checkValidity())return $(l).get(0).reportValidity?$(l).get(0).reportValidity():$(l).find('input[type="email"], input[type="text"]').css("border","1px solid red"),{v:!1};$(l).find('input[type="email"], input[type="text"]').css("border","1px solid #ccc");var c=$(l).serializeArray(),n=s.payModal+" .modal-content";c.push({name:$("meta[name=csrf-param]").attr("content"),value:LandingCore.getCsrfToken()}),c.push({name:"data[case_id]",value:r.caseId}),i.quantity=$(l).find('input[name="quantity"]').val();var d=$(p.selectors.upsale).val();null!=d&&0!=d.length&&1==$(p.selectors.openUpsale).hasClass("active")&&(d.forEach(function(e,t,o){c.push({name:"upsaleIDs[]",value:e})},r),c.push({name:"upsalePercent",value:$(p.selectors.upsalePercents).val()}),c.push({name:"certainCase",value:$(p.selectors.upsaleFixed).val()})),$.ajax({url:o.buyCaseUrl,method:"POST",dataType:"json",data:c,beforeSend:function(){LandingCore.blockUI().block(n),a.buyAction=!0,i.hideError();var e=new Event("beforeBuyCase",{bubbles:!0});document.dispatchEvent(e)},success:function(e){return"error"===e.status?(a.buyAction=!1,i.showError(e.msg),LandingCore.blockUI().unblock(n),!1):void("ok"===e.status&&setTimeout(function(){if("undefined"!=typeof e.redirectUrl)window.location.href=e.redirectUrl;else{var t=$.Event("updateBalance");$("body").trigger(t,[e.price]),e.count=i.quantity,e.xDrop=i.xDrop,ModalFallenGame.init(e),ModalFallenGame.show()}},300))},error:function(e,t,o){LandingCore.blockUI().unblock(n),a.buyAction=!1}})}();if("object"===("undefined"==typeof l?"undefined":_typeof(l)))return l.v}catch(o){throw t(o),e.preventDefault(),o}},onShowTermsLink:function(e){try{e.preventDefault(),$(s.rulesModal).modal("show")}catch(e){throw t(e),e}}},p={selectors:{openUpsale:"#open-upsale",upsaleBlock:".case-upsale",upsaleDropdowns:"#upsale-dropdowns",upsaleFixed:"#upsale-fixed",upsalePercents:"#upsale-percents",upsale:"#upsale",addedSumBlock:"#block-added-sum",addedSum:"#added-sum",upsaleClose:".upsale-close"},showNewPrice:!1,upsaleSelectpickerOptions:{tickIcon:"",noneSelectedText:LandingCore.t("Ничего не выбрано")},prevPercent:null,fillUpsale:function(e,s,a,r){try{p.clear(),e.forEach(function(e,t,o){$(p.selectors.upsalePercents).append($("<option></option>").attr("value",e).text("+"+e+"%"))},this),Object.values(s).forEach(function(e,t,s){var a=0;e.fixed_item==r.fixed_item_yes&&(a=1),$(p.selectors.upsale).append($("<option></option>").attr("value",e.id).attr("data-fixed-item",a).attr("data-content",'<i class="fa fa-square-o"></i> '+e.name).text(e.name)),o.upsales[e.id]=e},this),Object.values(a).forEach(function(e,t,o){$(p.selectors.upsaleFixed).append($("<option></option>").attr("value",e.id).text(e.name))},this),$(p.selectors.upsalePercents).selectpicker("refresh"),$(p.selectors.upsale).selectpicker("refresh"),$(p.selectors.upsaleFixed).selectpicker("refresh")}catch(e){throw t(e),e}},calculateUpsalePrice:function(){try{var e=$(p.selectors.upsalePercents),s=$(p.selectors.upsale),a=e.val(),r=s.val(),l=$("#payform-case-id").val(),n=parseFloat(parseFloat($("[data-item-id="+l+"]").attr("data-item-price"))*parseInt($(d.selectors.quantity).val())),u=null==r||!r.length;if(u)return $(p.selectors.addedSumBlock).addClass("hidden"),!1;for(var h=0,m=null,f=0;f<r.length;f++){m=o.upsales[r[f]];var y=parseInt(m["value_"+a]),v=m["incr_type_"+a];v==c?h+=y:v==i&&(h+=n/100*y),h=parseFloat(h.toFixed(2))}$(p.selectors.addedSumBlock).removeClass("hidden"),$(p.selectors.addedSum).text(h)}catch(e){throw t(e),e}},updateFixedUpsale:function(){try{var e=!1;$(p.selectors.upsale).find(":selected").each(function(){$(this).data("fixed-item")&&(e=!0)}),e?($(p.selectors.upsaleFixed).removeAttr("disabled"),$(p.selectors.upsaleFixed).prop("disabled",!1)):($(p.selectors.upsaleFixed).selectpicker("val",""),$(p.selectors.upsaleFixed).attr("disabled","disabled"),$(p.selectors.upsaleFixed).prop("disabled",!0)),$(p.selectors.upsaleFixed).selectpicker("refresh")}catch(e){throw t(e),e}},selectAnimationCheckBox:function(){try{var e=this.value-1,o=$(p.selectors.upsale).parent("div").find("ul li");o.each(function(t){if($(this).attr("data-original-index")==e||$(this).hasClass("selected")){var o=$(this).find("i");o.hasClass("fa-square-o")?(o.removeClass("fa-square-o"),o.addClass("fa-check-square-o")):$(this).hasClass("selected")||(o.removeClass("fa-check-square-o"),o.addClass("fa-square-o"))}});var s=$(p.selectors.upsale).parent("div").find("button i");s.each(function(e){$(this).removeClass("fa-square-o"),$(this).addClass("fa-check-square-o")})}catch(e){throw t(e),e}},clear:function(e){try{if(e){var o=$(d.selectors.paymodalForm);$(o).find(p.selectors.upsalePercents).find("option").remove(),$(o).find(p.selectors.upsale).find("option").remove(),$(o).find(p.selectors.upsaleFixed).find("option").remove()}else $(p.selectors.upsalePercents).find("option").remove(),$(p.selectors.upsale).find("option").remove(),$(p.selectors.upsaleFixed).find("option").remove()}catch(e){throw t(e),e}},init:function(){try{$(p.selectors.upsale).selectpicker(p.upsaleSelectpickerOptions),$(p.selectors.upsalePercents).selectpicker(),$(p.selectors.upsaleFixed).selectpicker(p.upsaleSelectpickerOptions)}catch(e){throw t(e),e}},openUpsale:function(e){try{e.preventDefault(),$(p.selectors.openUpsale).toggleClass("active"),$(p.selectors.openUpsale).hasClass("active")&&p.selectFirstElements(),$(p.selectors.upsaleBlock).find(p.selectors.upsaleDropdowns).toggleClass("hidden"),$(p.selectors.addedSumBlock).hasClass("hidden")||0!=p.showNewPrice?null!=$(p.selectors.upsale).val()&&0!=$(p.selectors.upsale).val().length&&$(p.selectors.addedSumBlock).removeClass("hidden"):$(p.selectors.addedSumBlock).addClass("hidden"),$(p.selectors.upsaleClose).toggleClass("hidden"),p.showNewPrice=!1}catch(e){throw t(e),e}},changeUpsale:function(e){try{var s=$(p.selectors.upsalePercents),a=$(p.selectors.upsale);$(p.selectors.upsaleFixed);$(this).is(s)&&null===p.prevPercent&&a.val(a.find("option").eq(0).val());var r=s.val(),l=a.val();p.prevPercent=r,l==-1?p.updateFixedUpsale():p.updateFixedUpsale(),r==-1?(p.prevPercent=null,p.disableSelect(a,!0),p.updateFixedUpsale()):(p.disableSelect(a,!1),o.deselectUpsales&&(a.selectpicker("deselectAll"),o.deselectUpsales=!1)),p.calculateUpsalePrice()}catch(e){throw t(e),e}},disableSelect:function(e,o){try{o?(e.selectpicker("val",""),e.attr("disabled","disabled"),e.prop("disabled",!0)):(e.removeAttr("disabled"),e.prop("disabled",!1)),e.selectpicker("refresh")}catch(e){throw t(e),e}},upsaleHide:function(e){try{$(p.selectors.openUpsale).removeClass("active"),$(p.selectors.addedSumBlock).addClass("hidden"),$(p.selectors.upsaleClose).addClass("hidden"),$(p.selectors.upsaleBlock).find(p.selectors.upsaleDropdowns).hasClass("hidden")||$(p.selectors.upsaleBlock).find(p.selectors.upsaleDropdowns).addClass("hidden"),p.clear(e)}catch(e){throw t(e),e}},selectFirstElements:function(){try{$(p.selectors.upsalePercents+" :nth-child(1)").prop("selected",!0).trigger("change"),$(p.selectors.upsale+" :nth-child(1)").prop("selected",!0).trigger("change"),p.showNewPrice=!0}catch(e){throw t(e),e}}};r.on("click",s.outerGameTabs+" a",function(e){try{var o=$(this).data("target-tab-id"),a=$(s.outerTabPane);if($(this).parent("li").hasClass("active"))return!1;a.addClass("hidden").removeClass("in"),$(o).removeClass("hidden").addClass("in")}catch(e){throw t(e),e}}).on("click",s.gameBlockOuter,function(e){e.preventDefault();var t=$(this).data("item-id");$.post(o.getCaseInfoUrl,{itemId:t},function(e){"ok"===e.status&&(r.append(e.html),n.show())})}).on("click",s.payModalInitiator,function(e){e.preventDefault(),$(this).hasClass("retail-initiator")&&n.hide(),d.setParams($(this)),d.show()}).on("click",s.payModalPromoInitiator,function(e){var r=this;try{var l=function(){if(e.preventDefault(),a.checkPromocode)return{v:!1};var t=$(r).closest("form");if(!t.get(0).checkValidity())return $(t).get(0).reportValidity?$(t).get(0).reportValidity():$(t).find('input[type="email"], input[type="text"]').css("border","1px solid red"),{v:!1};var l=$(r),i=l.attr("data-item-id"),c=t.find(s.promocodeHash).val();a.checkPromocode=!0,$.ajax({url:o.promoCodeCheckUrl,method:"POST",dataType:"json",data:{_csrf:LandingCore.getCsrfToken(),case_id:i,hash:c,promotionalCodeType:o.promocodeSettings.promotionalCodeType,promotionalCodeSubType:o.promocodeSettings.promotionalCodeSubType,data:{case_id:i}},success:function(e){if(a.checkPromocode=!1,l.attr("data-promocode",""),"error"===e.status){t.find(s.promoErrorMsg).removeClass("hidden"),t.find(s.promocodeHash).parent().addClass("has-error");var o=s.payModal+" .modal-content";return LandingCore.blockUI().unblock(o),!1}t.find(s.promoErrorMsg).addClass("hidden"),t.find(s.promocodeHash).parent().removeClass("has-error"),l.attr("data-promocode",c),d.setParams(l,e),d.show()},error:function(e,t,o){a.checkPromocode=!1,d.unblock&&d.unblock()}})}();if("object"===("undefined"==typeof l?"undefined":_typeof(l)))return l.v}catch(e){throw t(e),e}}).on("click",p.selectors.openUpsale+","+p.selectors.upsaleClose,p.openUpsale).on("change",p.selectors.upsalePercents+","+p.selectors.upsale,p.changeUpsale).on("change",$(p.selectors.upsale),p.selectAnimationCheckBox),p.init(),$(s.fancyboxImage).fancybox(),o.visitor&&(o.visitor.visitPayModal(d),o.visitor.visitSelectors(s),o.visitor.visitPageOptions(o))};